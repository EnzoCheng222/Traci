# 實作與論文方法比較分析

**文件版本**: 1.0  
**最後更新**: 2025-11-27  
**專案**: 交通號誌控制方法比較實驗

---

## 目錄

1. [Webster + PID 方法比較](#1-webster--pid-方法比較)
2. [PPO 方法比較](#2-ppo-方法比較)
3. [Max Pressure 方法比較](#3-max-pressure-方法比較)
4. [LLM 方法比較](#4-llm-方法比較)
5. [總結](#5-總結)

---

## 1. Webster + PID 方法比較

### 論文原始方法（sensors-25-03501）

**核心公式**:
```
C* = (1.5L + 5) / (1 - Y)
g_i = (y_i / Y) × (C* - L)
y_i = q_i / s_i
```

**實作流程**:
1. 收集流量數據（非即時）
2. 計算 flow ratio (y_i)
3. 計算最佳週期 (C*)
4. 分配綠燈時間 (g_i)
5. 固定週期執行整場模擬

**特點**:
- 純固定時制
- 不含 PID 調整
- 一次計算，全程使用

---

### 本專案實作方法

**程式檔案**: `traci.Webster_PID.py`

**核心邏輯**:
```python
# 1. Webster 計算（每 60 秒重新計算）
C_base = (1.5 * L + 5.0) / max(1e-6, (1.0 - Y))
G_EB = (y_EB / Y) * effective_green
G_SB = (y_SB / Y) * effective_green

# 2. PID 調整
error_EB = target_queue - current_queue_EB
adjustment_EB = Kp × error + Ki × integral + Kd × derivative
G_EB_adjusted = G_EB + adjustment_EB
```

**實作流程**:
1. **每 60 秒**重新計算 Webster 週期
2. 使用滑動視窗平均流量
3. Webster 計算基礎綠燈時間
4. **PID 控制器**根據排隊誤差調整
5. 動態更新綠燈時間

**關鍵參數**:
- 控制週期 (T_CONTROL): 60 秒
- 飽和流率: 1800 veh/h/lane
- PID 參數: Kp=0.5, Ki=0.1, Kd=0.2
- 最小綠燈: 10 秒
- 黃燈時間: 3 秒

---

### 主要差異

| 特性 | 論文方法 | 本專案實作 |
|------|---------|-----------|
| **時制類型** | 純固定時制 | 半自適應（60s 更新） |
| **PID 控制** | ❌ 無 | ✅ 有 |
| **更新頻率** | 一次計算 | 每 60 秒重算 |
| **流量輸入** | 初始設定 | 滑動視窗平均 |
| **適應性** | 無 | 有限適應 |

### 實作原因

**為何加入 PID**:
- 論文的純 Webster 在動態車流下表現不佳
- PID 提供即時反饋調整能力
- 嘗試改善 Webster 的適應性

**為何 60 秒更新**:
- 平衡計算成本與適應性
- 避免過於頻繁的週期變動
- 符合傳統交通工程實務

### 實驗結果對比

**論文結論**: Webster 在高需求模擬中表現顯著劣於智能控制方法

**本專案結果**:
- Total Avg Queue: 73.10 veh（第 4 名，最差）
- Avg Delay: 48.25 s（第 4 名，最差）
- 即使加入 PID，仍無法與 PPO/MaxP 競爭

**結論**: PID 的加入未能根本改善 Webster 的局限性，證明了固定時制方法在高動態場景的不足。

---

## 2. PPO 方法比較

### 論文原始方法（arXiv:1707.06347）

**核心公式**:
```
L_CLIP(θ) = E_t[min(r_t(θ)Â_t, clip(r_t(θ), 1-ε, 1+ε)Â_t)]
r_t(θ) = π_θ(a_t|s_t) / π_θ_old(a_t|s_t)
Â_t = Σ(γλ)^l δ_{t+l}
```

**標準流程**:
1. 收集 rollouts（on-policy）
2. 計算 GAE advantage
3. 多 epoch 更新 policy
4. 更新 value function
5. θ_old ← θ

**超參數**:
- γ: 0.99
- λ: 0.95
- ε: 0.1~0.2
- Learning rate: 3e-4

---

### 本專案實作方法

**程式檔案**: `traci.PPO.update.py`

**狀態空間 (13 維)**:
```python
state = [
    q_EB_0, q_EB_1, q_EB_2,  # EB 各車道 queue
    q_SB_0, q_SB_1, q_SB_2,  # SB 各車道 queue
    h_EB_0, h_EB_1, h_EB_2,  # EB 各車道 halting
    h_SB_0, h_SB_1, h_SB_2,  # SB 各車道 halting
    current_phase             # 當前相位
]
```

**動作空間**:
```python
action ∈ {0, 1, 2, 3}  # 4 個離散相位
# Phase 0: EB 綠燈
# Phase 1: EB 黃燈
# Phase 2: SB 綠燈
# Phase 3: SB 黃燈
```

**獎勵函數**:
```python
reward = -(halting_EB + halting_SB)
```

**模型**:
- 使用預訓練模型: `ppo_traffic_signal.zip`
- 基於 Stable-Baselines3 實作
- 決策頻率: 每 0.1 秒

---

### 主要差異

| 特性 | 論文標準方法 | 本專案實作 |
|------|-------------|-----------|
| **狀態表示** | 通用（未指定） | 13 維向量（queue + halting + phase） |
| **動作空間** | 通用（未指定） | 4 個離散相位 |
| **Reward 設計** | 通用（未指定） | 負停等車輛數 |
| **訓練方式** | 從零訓練 | 使用預訓練模型 |
| **應用場景** | 通用 RL | 交通號誌控制 |

### 實作特點

**狀態設計考量**:
- 包含細粒度資訊（每車道獨立）
- 同時考慮 queue 和 halting
- 加入相位資訊避免頻繁切換

**Reward 設計考量**:
- 簡單直接：最小化停等車輛
- 與實驗目標一致（減少延滯）
- 避免複雜的多目標權重

**使用預訓練模型**:
- 節省訓練時間
- 確保穩定表現
- 專注於方法比較而非訓練調參

### 實驗結果對比

**論文結論**: PPO 在多種環境中表現穩定，sample efficiency 高

**本專案結果**:
- Total Avg Queue: 40.58 veh（第 1 名，最佳）
- Avg Delay: 21.01 s（第 1 名，最佳）
- 標準差極小，表現穩定

**結論**: PPO 在交通號誌控制場景中的優異表現得到驗證，證明了強化學習方法的有效性。

---

## 3. Max Pressure 方法比較

### 論文原始方法（Varaiya, 2013）

**核心公式**:
```
P_ab = Q_ab - Σ_c p_bc * Q_bc
P(p) = Σ_{(a,b) ∈ M_p} s_ab · P_ab
p* = argmax_p P(p)
```

**標準流程**:
1. 讀取上游 queue (Q_ab)
2. 讀取下游 queue (Q_bc)
3. 計算 movement pressure
4. 計算 phase pressure
5. 選擇壓力最大的相位
6. 保持該相位直到下次決策

**特點**:
- 考慮上下游壓力差
- 需要 turning ratio (p_bc)
- 理論保證網路穩定性

---

### 本專案實作方法

**程式檔案**: `traci.maxpressure.fixed_yellow.compare.py`

**簡化公式**:
```python
# 不考慮下游壓力和 turning ratio
pressure_EB = queue_EB
pressure_SB = queue_SB

if queue_EB > queue_SB + THRESHOLD:
    target_phase = EB_PHASE
elif queue_SB > queue_EB + THRESHOLD:
    target_phase = SB_PHASE
else:
    保持當前相位
```

**實作流程**:
1. 讀取 EB/SB 總排隊數
2. 計算壓力差
3. 如果壓力差 > 閾值，切換相位
4. 檢查最小綠燈時間（10 秒）
5. 執行黃燈過渡（3 秒）
6. 切換到目標相位

**關鍵參數**:
- THRESHOLD: 0 車輛（標準 Max Pressure）
- MIN_GREEN: 10 秒
- YELLOW_TIME: 3 秒
- 決策頻率: 每 0.1 秒

---

### 主要差異

| 特性 | 論文方法 | 本專案實作 |
|------|---------|-----------|
| **壓力計算** | P_ab = Q_ab - Σ p_bc * Q_bc | P = Q_upstream |
| **下游考慮** | ✅ 有 | ❌ 無 |
| **Turning Ratio** | ✅ 需要 | ❌ 不需要 |
| **Movement 層級** | ✅ 細粒度 | ❌ 方向層級 |
| **切換閾值** | 無 | 0（可調整） |
| **最小綠燈** | 無明確規定 | 10 秒 |

### 簡化原因

**為何不考慮下游**:
- 單路口場景，無明確下游路口
- 簡化實作複雜度
- 專注於上游排隊疏解

**為何不使用 turning ratio**:
- SUMO 模擬中 turning ratio 不易準確獲取
- 對單路口影響有限
- 保持方法簡潔性

**為何加入 THRESHOLD**:
- 避免過度頻繁切換
- 實驗中設為 0（標準 Max Pressure）
- 可調整以平衡穩定性與反應性

### 實驗結果對比

**論文結論**: Max Pressure 保證網路穩定性，在高需求下表現優異

**本專案結果**:
- Total Avg Queue: 40.60 veh（第 2 名）
- Avg Delay: 21.02 s（第 2 名）
- 與 PPO 幾乎平手（差異 < 0.1%）

**結論**: 即使是簡化版的 Max Pressure，仍展現了驚人的效能，證明了壓力平衡原理的強大。

---

## 4. LLM 方法比較

### 論文原始方法（arXiv:2312.16044v5）

**核心設計**:
```
狀態 → 自然語言描述 → LLM 推理 → JSON 輸出 → 控制動作
```

**Prompt 結構（RAP Method）**:
```
You are an intelligent traffic signal controller.

Traffic Status: [狀態描述]

Goal: minimize queue length and delay.

Step 1: analyze traffic.
Step 2: compare each possible phase.
Step 3: choose the best phase and duration.

Output:
Thought: <reasoning>
Action: {"phase": "...", "duration": ...}
```

**輸出格式**:
- Phase: NS_straight, EW_straight, NS_left, EW_left
- Duration: 10~60 秒

**模型**: GPT-4, GPT-4-turbo

**控制方式**: 動態決定相位和持續時間

---

### 本專案實作方法

**程式檔案**: `traci.LLM.RAP.compare.py`

**狀態編碼**:
```python
text_description = f"""Traffic Condition at Node2:

East-West Direction (EB):
  - Queue length: {q_EB} vehicles
  - Halting vehicles: {h_EB} vehicles

South-North Direction (SB):
  - Queue length: {q_SB} vehicles
  - Halting vehicles: {h_SB} vehicles

Current Signal Phase: {current_phase_name}

Available Actions:
  - "EB": Give green light to East-West direction
  - "SB": Give green light to South-North direction
"""
```

**簡化 Prompt**:
```
You are an intelligent traffic signal controller.

Traffic Status: [狀態描述]

Goal: Minimize queue length and delay.

Task: Decide which phase should be active for the next 20 seconds.
- Option 1: "EB" (East-West Green)
- Option 2: "SB" (South-North Green)

Instructions:
1. Analyze the queue and halting vehicles.
2. If the current green phase still has a long queue, keep it (Extension).
3. If the waiting phase has a much longer queue, switch to it.
4. Output JSON only.

Format:
Thought: <reasoning>
Action: {"phase": "EB" or "SB"}
```

**輸出格式**:
```json
{
  "phase": "EB" or "SB"
}
```
（不包含 duration）

**模型**: Google Gemini 2.5-flash

**控制方式**: 
- **固定 20 秒控制週期**
- LLM 只決定相位，不決定持續時間
- Extension 機制：相位相同則延長 20 秒

---

### 主要差異

| 特性 | 論文方法 | 本專案實作 |
|------|---------|-----------|
| **LLM 模型** | GPT-4 | Gemini 2.5-flash |
| **控制間隔** | 動態（LLM 決定） | 固定 20 秒 |
| **LLM 決策範圍** | Phase + Duration | 僅 Phase |
| **Duration 控制** | LLM 輸出 10~60s | 固定 20s（或 17s+3s 黃燈） |
| **相位數量** | 4 個（含左轉） | 2 個（EB/SB） |
| **Fallback 機制** | 論文未明確說明 | Max Pressure |

### 修改原因

**為何使用 Gemini**:
- 免費 API 額度
- 實驗成本考量
- 驗證 LLM 方法的通用性

**為何固定 20 秒週期**:
- **API Rate Limit**: 免費版有嚴格的請求限制
- **避免過短綠燈**: 保證最小 17 秒綠燈（20s - 3s 黃燈）
- **降低 API 調用頻率**: 從潛在的每 10 秒降至 20 秒

**為何 LLM 不決定 duration**:
- 簡化 LLM 任務，提高輸出穩定性
- 固定週期更易於管理和比較
- 避免 LLM 輸出過短或過長的綠燈時間

**Fallback 機制**:
```python
if API_failed or parse_failed or invalid_phase:
    使用 Max Pressure 決策
```
- 確保系統穩定運行
- 應對 API 限制和錯誤

### API 限制處理

**Rate Limit 策略**:
```python
if "429" in error:
    print("Rate Limit hit! Fallback to Max Pressure.")
    return None  # 不等待，直接 Fallback
```

**重試機制**:
- 最多重試 3 次
- 非 429 錯誤等待 2 秒後重試
- 429 錯誤直接 Fallback

### 實驗結果對比

**論文結論**: LLM RAP 在低流量時接近 RL，在高流量時更穩定

**本專案結果**:
- Total Avg Queue: 66.61 veh（第 3 名）
- Avg Delay: 42.65 s（第 3 名）
- **Fallback Rate: 37.7%**（高）
- 優於 Webster，但落後於 PPO/MaxP

**結論**: 
- LLM 方法的可行性得到驗證
- API 限制是主要瓶頸（37.7% Fallback）
- 固定週期設計成功避免了系統卡死
- 免費 API 不適合高頻控制場景

---

## 5. 總結

### 實作與論文的總體對比

| 方法 | 論文忠實度 | 主要修改 | 修改原因 |
|------|-----------|---------|---------|
| **Webster + PID** | 中等 | 加入 PID、60s 更新 | 嘗試改善適應性 |
| **PPO** | 高 | 狀態/動作/Reward 具體化 | 適配交通場景 |
| **Max Pressure** | 中等 | 簡化壓力計算 | 單路口簡化 |
| **LLM** | 中等 | 固定週期、僅決定相位 | API 限制、穩定性 |

### 實作哲學

#### 1. 實用性優先
- 所有修改都基於實際限制（API 額度、單路口場景）
- 避免過度複雜化

#### 2. 可比較性
- 統一評估指標
- 相同模擬環境
- 一致的實驗設定

#### 3. 穩定性保證
- LLM 的 Fallback 機制
- Max Pressure 的最小綠燈時間
- Webster 的週期限制

### 實驗價值

**本專案的貢獻**:
1. **驗證了論文方法在 SUMO 環境的有效性**
2. **展示了簡化實作的可行性**（如 Max Pressure）
3. **揭示了 API 限制對 LLM 方法的影響**
4. **證明了 Webster 在動態場景的局限性**（即使加入 PID）

**與論文的一致性**:
- PPO 和 Max Pressure 的優異表現 ✅
- Webster 的不足 ✅
- LLM 的可行性但有限制 ✅

### 未來改進方向

#### Webster + PID
- 縮短更新週期（30 秒）
- 更激進的 PID 參數
- 但根本問題仍是固定時制的局限

#### PPO
- 更複雜的 Reward 設計（多目標）
- 更細粒度的動作空間
- 已經表現極佳，改進空間有限

#### Max Pressure
- 加入下游壓力考慮（多路口）
- 實作 turning ratio
- 但簡化版已經非常有效

#### LLM
- **使用付費 API**（移除 Rate Limit）
- 嘗試更強的模型（GPT-4）
- 恢復動態 duration 決策
- 這是最有潛力的改進方向

---

**文件結束**

# Max-Pressure 交通號誌控制系統

## 程式版本資訊

**檔案名稱**: `traci.maxpreesure.py`  
**最後更新**: 2025-11-23  
**模擬時間**: 1800 秒 (30 分鐘)  
**時間步長**: 0.1 秒

---

## 一、程式功能

本程式實現了基於 **Max-Pressure** 演算法的交通號誌控制系統,用於 SUMO (Simulation of Urban MObility) 交通模擬環境。主要功能包括:

### 1.1 核心功能
- ✅ **動態號誌控制**: 根據即時交通壓力自動調整號誌相位
- ✅ **雙向偵測**: 同時監控東向 (EB) 和南向 (SB) 的交通狀況
- ✅ **最小綠燈時間保護**: 確保每個相位至少維持 10 秒綠燈 (100 steps × 0.1s)
- ✅ **自動相位識別**: 自動偵測哪些相位屬於 EB 或 SB 綠燈

### 1.2 統計與監控功能
- 📊 **車輛排隊數 (Queue)**: 監控每個車道的總車輛數
- 📊 **停等車輛數 (Halting)**: 監控每個車道的停等車輛數
- 📊 **黃燈偵測**: 自動識別並統計黃燈時間
- 📊 **相位使用統計**: 記錄每個相位的使用比例
- 📊 **到達車輛數**: 統計完成通過路口的車輛總數
- 📊 **綠燈比例**: 計算 EB 和 SB 方向的綠燈時間比例

### 1.3 輸出資訊
程式會輸出以下詳細統計資料:
- EB/SB 平均排隊車輛數
- EB/SB 平均停等車輛數
- 總平均排隊長度
- EB/SB 綠燈比例
- 黃燈比例
- 各時相使用比例
- 總到達車輛數
- 平均延滯時間 (sec/veh)
- 總停等時間 (veh·sec)
- 累積獎勵值

---

## 二、控制邏輯

### 2.1 Max-Pressure 演算法原理

Max-Pressure 是一種基於 **壓力差** 的交通號誌控制策略:

```
壓力 (Pressure) = 上游排隊車輛數 - 下游排隊車輛數
```

在本實作中,我們簡化為:
- **EB 壓力** = 東向排隊車輛數 (q_EB)
- **SB 壓力** = 南向排隊車輛數 (q_SB)

### 2.2 決策規則

```python
if q_EB > q_SB:
    # 東向壓力較大 → 切換到 EB 綠燈相位
    if current_phase not in EB_PHASES:
        switch_to_EB_phase()
        
elif q_SB > q_EB:
    # 南向壓力較大 → 切換到 SB 綠燈相位
    if current_phase not in SB_PHASES:
        switch_to_SB_phase()
        
else:
    # 壓力相同 → 維持當前相位
    keep_current_phase()
```

### 2.3 安全限制

為了避免頻繁切換造成的安全問題和效率降低,實施以下限制:

1. **最小綠燈時間**: 每個相位至少維持 10 秒 (100 steps)
2. **黃燈過渡**: 相位切換時會經過黃燈階段
3. **相位循環**: 按照預設的相位順序循環切換

---

## 三、控制目標

### 3.1 主要目標

**最小化總停等時間 (Minimize Total Waiting Time)**

透過動態調整號誌相位,讓壓力較大的方向優先通行,從而減少整體路網的:
- 車輛停等時間
- 排隊長度
- 延滯時間

### 3.2 次要目標

- 提高路口通行效率
- 平衡各方向的服務水準
- 避免某一方向長時間等待

---

## 四、獎勵函數 (Reward Function)

### 4.1 獎勵定義

```python
def get_reward(q_EB, q_SB):
    """
    Reward = - (EB + SB 總排隊車數)
    """
    total_queue = q_EB + q_SB
    return -float(total_queue)
```

### 4.2 獎勵說明

- **負值獎勵**: 排隊車輛越多,獎勵越負 (懲罰越大)
- **目標**: 最大化累積獎勵 = 最小化總排隊車輛數
- **即時反饋**: 每個時間步都會計算獎勵值

### 4.3 獎勵特性

| 特性 | 說明 |
|------|------|
| **即時性** | 每 0.1 秒更新一次 |
| **全域性** | 考慮整個路口的總體狀況 |
| **簡潔性** | 直接反映系統壓力 |
| **可比較性** | 可用於比較不同控制策略的效能 |

---

## 五、偵測器配置

### 5.1 東向 (Eastbound) 偵測器

| 偵測器 ID | 功能 | 監控指標 |
|-----------|------|----------|
| `Node1_2_EB_0` | 車道 0 | 車輛數 + 停等數 |
| `Node1_2_EB_1` | 車道 1 | 車輛數 + 停等數 |
| `Node1_2_EB_2` | 車道 2 | 車輛數 + 停等數 |

### 5.2 南向 (Southbound) 偵測器

| 偵測器 ID | 功能 | 監控指標 |
|-----------|------|----------|
| `Node2_4_SB_0` | 車道 0 | 車輛數 + 停等數 |
| `Node2_4_SB_1` | 車道 1 | 車輛數 + 停等數 |
| `Node2_4_SB_2` | 車道 2 | 車輛數 + 停等數 |

### 5.3 監控指標說明

- **車輛數 (Vehicle Number)**: 偵測區域內的總車輛數
- **停等數 (Halting Number)**: 偵測區域內速度接近 0 的車輛數

---

## 六、程式流程

```
1. 初始化 SUMO 連線
   ↓
2. 自動偵測 EB/SB 相位
   ↓
3. 開始模擬迴圈 (18000 steps)
   ├─ 讀取當前相位狀態 (綠燈/黃燈)
   ├─ 讀取偵測器數據 (q_EB, q_SB, h_EB, h_SB)
   ├─ 統計數據收集
   ├─ Max-Pressure 決策
   ├─ 執行相位切換 (如需要)
   ├─ SUMO 模擬前進一步
   ├─ 計算獎勵值
   └─ 輸出 Log (每 10 秒)
   ↓
4. 關閉 SUMO
   ↓
5. 輸出統計報告
```

---

## 七、關鍵參數

| 參數名稱 | 數值 | 說明 |
|----------|------|------|
| `SIM_TIME` | 1800 秒 | 總模擬時間 |
| `STEP_LENGTH` | 0.1 秒 | 每步時間長度 |
| `TOTAL_STEPS` | 18000 | 總步數 |
| `MIN_GREEN_STEPS` | 100 | 最小綠燈步數 (10 秒) |
| `TLS_ID` | "Node2" | 控制的號誌 ID |

---

## 八、與 PPO 版本的差異

| 項目 | Max-Pressure | PPO |
|------|--------------|-----|
| **控制方式** | 規則式 (Rule-based) | 學習式 (Learning-based) |
| **決策依據** | 即時排隊車輛數比較 | 神經網路策略 |
| **適應性** | 固定規則 | 持續學習改進 |
| **複雜度** | 低 | 高 |
| **可解釋性** | 高 (邏輯清晰) | 低 (黑箱模型) |
| **訓練需求** | 無需訓練 | 需要訓練過程 |

---

## 九、使用方式

### 9.1 執行程式

```bash
python traci.maxpreesure.py
```

### 9.2 前置需求

1. 已安裝 SUMO
2. 已設定 `SUMO_HOME` 環境變數
3. 存在 `Traci.sumocfg` 設定檔
4. 網路檔案中包含所需的偵測器

### 9.3 實際測試結果

**測試日期**: 2025-11-23  
**測試環境**: Traci.sumocfg  
**模擬時長**: 1800 秒 (30 分鐘)

```
========== Max-Pressure Summary (Objective: Min Waiting Time) ==========
EB 平均排隊 (Queue) = 11.38 veh
SB 平均排隊 (Queue) = 12.58 veh
Total Avg Queue     = 23.95 veh
EB 平均停等 (Halt)  = 5.00 veh
SB 平均停等 (Halt)  = 6.06 veh

EB 綠燈比例         = 0.45
SB 綠燈比例         = 0.48
黃燈比例 (Yellow)   = 0.08

各時相比例 (Phase Ratios):
  Phase 0: 0.48
  Phase 1: 0.04
  Phase 2: 0.45
  Phase 3: 0.03

Total Arrived Veh   = 2591
Avg Delay Time      = 7.69 sec/veh
Total Waiting Time  = 19916.20 veh·sec
Cumulative reward   = -431179.00
========================================================================
```

#### 結果分析

**交通流量平衡**:
- EB 和 SB 方向的排隊車輛數相當接近 (11.38 vs 12.58),顯示 Max-Pressure 成功平衡了兩個方向的交通壓力
- 綠燈比例也相當均衡 (EB: 0.45, SB: 0.48),符合實際交通需求

**停等效能**:
- EB 平均停等: 5.00 輛 (佔排隊車輛的 43.9%)
- SB 平均停等: 6.06 輛 (佔排隊車輛的 48.2%)
- 停等比例合理,表示車輛大多能保持移動狀態

**服務水準**:
- 總到達車輛數: 2591 輛
- 平均延滯時間: **7.69 秒/車** ← 相當優秀的表現
- 總停等時間: 19916.20 車·秒

**相位使用**:
- Phase 0 (SB 綠燈): 48% - 主要南向通行相位
- Phase 2 (EB 綠燈): 45% - 主要東向通行相位  
- Phase 1 & 3 (黃燈): 4% + 3% = 7% - 過渡相位
- 黃燈總比例: 8% (合理範圍)

**整體評價**:
✅ Max-Pressure 演算法在此測試場景中表現優異,成功維持了雙向交通的平衡,並將平均延滯時間控制在 8 秒以下,顯示出良好的即時反應能力和控制效果。

---

## 十、優點與限制

### 10.1 優點

✅ **簡單直觀**: 邏輯清晰,易於理解和除錯  
✅ **即時反應**: 能快速回應交通狀況變化  
✅ **無需訓練**: 不需要歷史數據或訓練過程  
✅ **穩定可靠**: 行為可預測,不會出現異常決策  
✅ **計算效率高**: 運算負擔小

### 10.2 限制

⚠️ **缺乏預測能力**: 只考慮當前狀態,無法預測未來  
⚠️ **規則固定**: 無法自動適應不同的交通模式  
⚠️ **局部最優**: 可能陷入局部最優解  
⚠️ **簡化假設**: 未考慮下游路段容量等複雜因素

---

## 十一、改進方向

1. **加入預測機制**: 結合歷史數據預測未來交通流
2. **多路口協調**: 擴展到區域性號誌協調控制
3. **動態參數調整**: 根據時段自動調整最小綠燈時間
4. **優先權處理**: 加入公車、緊急車輛優先通行機制
5. **混合策略**: 結合 Max-Pressure 和學習式方法的優點

---

## 十二、參考文獻

- Varaiya, P. (2013). Max pressure control of a network of signalized intersections. *Transportation Research Part C: Emerging Technologies*, 36, 177-195.
- Gregoire, J., Qian, X., Frazzoli, E., de La Fortelle, A., & Wongpiromsarn, T. (2015). Capacity-aware backpressure traffic signal control. *IEEE Transactions on Control of Network Systems*, 2(2), 164-173.

---

**文件版本**: 1.0  
**建立日期**: 2025-11-23  
**作者**: Traffic Control System Team
